import TelegramBot from 'node-telegram-bot-api';
import difference from 'lodash/difference';
import UsersRepository from '@/repositories/users';
import FinanceAggregation from '@/utils/finance-aggregation';
import getCurrencyWithFlag from '@/utils/get-currency-with-flag';
import { Actions, IAction } from '@/interfaces/bot';
import IUser from '@/interfaces/user';
import { Currencies } from '@/interfaces/common';

class Bot {
  private _bot: TelegramBot;

  public constructor(
    token: string,
    port: number,
    private _usersRepository: UsersRepository,
    private _financeAggregation: FinanceAggregation,
  ) {
    this._bot = new TelegramBot(token, {
      webHook: {
        port,
      },
    });

    this._initializeRoutes();
  }

  public setWebHook = (url: string) => {
    this._bot.setWebHook(url);
  };

  private _initializeRoutes = () => {
    this._bot.onText(/\/start/, this._start);

    this._bot.onText(/\/menu/, this._menu);

    this._bot.onText(/–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤–∞–ª—é—Ç üí±/, this._exchange);
    this._bot.onText(/\/exchange/, this._exchange);

    this._bot.onText(/–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è/, this._settings);
    this._bot.onText(/\/settings/, this._settings);

    this._bot.onText(/–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚ÑπÔ∏è/, this._information);
    this._bot.onText(/\/information/, this._information);

    this._bot.on('callback_query', this._callbackQuery);
  };

  private _getMenuButtons = (): TelegramBot.SendMessageOptions => ({
    parse_mode: 'Markdown',
    reply_markup: {
      keyboard: [
        [{ text: '–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤–∞–ª—é—Ç üí±' }],
        [{ text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è' }],
        [{ text: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚ÑπÔ∏è' }],
      ],
      resize_keyboard: true,
    },
  });

  private _start = async (message: TelegramBot.Message) => {
    const {
      id: _id,
      first_name: firstName,
      last_name: lastName,
      username,
    } = message.chat;

    const foundUser = await this._usersRepository.find(_id);

    if (foundUser) return;

    const user: IUser = {
      _id,
      firstName,
      lastName,
      username,
      currencies: [Currencies.USD, Currencies.EUR],
    };

    await this._usersRepository.insert(user);

    const msg =
      '–ü—Ä–∏–≤–µ—Ç! üöÄ –Ø —É–º–µ—é –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤–∞–ª—é—Ç –≤ –£–∫—Ä–∞–∏–Ω–µ üá∫üá¶!\n\n*–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤–∞–ª—é—Ç üí±* - –≤–µ—Ä–Ω–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤–∞–ª—é—Ç –¥–ª—è —Ç–≤–æ–µ–≥–æ —Å–ø–∏—Å–∫–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, —ç—Ç–æ - *USD üá∫üá∏* –∏ *EUR üá™üá∫*.\n*–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è* - –ø–æ–∑–≤–æ–ª–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–ª—é—Ç.\n*–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚ÑπÔ∏è* - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.';

    this._bot.sendMessage(_id, msg, this._getMenuButtons());
  };

  private _menu = (message: TelegramBot.Message) => {
    const { id } = message.chat;

    this._bot.sendMessage(id, '–ú–µ–Ω—é:', this._getMenuButtons());
  };

  private _exchange = async (message: TelegramBot.Message) => {
    try {
      const { id: _id } = message.chat;

      const foundUser = await this._usersRepository.find(_id);

      if (!foundUser) {
        throw new Error("User wasn't found");
      }

      const { currencies } = foundUser;

      const response = (
        await this._financeAggregation.getAggregation(currencies)
      ).join('\n\n');

      if (!response) {
        this._bot.sendMessage(
          _id,
          '–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∞–∫—Ç–∏–≤–Ω—É—é –≤–∞–ª—é—Ç—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö üôÇ',
        );
        return;
      }

      const options: TelegramBot.SendMessageOptions = {
        parse_mode: 'Markdown',
      };

      this._bot.sendMessage(_id, response, options);
    } catch (e) {
      console.error(e);
    }
  };

  private _settings = async (message: TelegramBot.Message) => {
    try {
      const { id: _id } = message.chat;

      const foundUser = await this._usersRepository.find(_id);

      if (!foundUser) {
        throw new Error("User wasn't found");
      }

      const { currencies } = foundUser;

      const options: TelegramBot.SendMessageOptions = {
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [
              {
                text: '–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª—é—Ç—É',
                callback_data: JSON.stringify({
                  action: Actions.ADD_CURRENCIES,
                }),
              },
            ],
            [
              {
                text: '–£–¥–∞–ª–∏—Ç—å –≤–∞–ª—é—Ç—É',
                callback_data: JSON.stringify({
                  action: Actions.REMOVE_CURRENCIES,
                }),
              },
            ],
          ],
        },
      };

      const activeCurrencies = currencies.map(getCurrencyWithFlag).join(', ');

      this._bot.sendMessage(
        _id,
        `–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–ª—é—Ç:\n*${activeCurrencies}*`,
        options,
      );
    } catch (e) {
      console.error(e);
    }
  };

  private _information = async (message: TelegramBot.Message) => {
    try {
      const { id: _id } = message.chat;

      const foundUser = await this._usersRepository.find(_id);

      if (!foundUser) {
        throw new Error("User wasn't found");
      }

      const allCurrenciesList = Object.values(Currencies)
        .map(getCurrencyWithFlag)
        .join(', ');
      const userCurrenciesList = foundUser.currencies
        .map(getCurrencyWithFlag)
        .join(', ');

      const msg = `–Ø –∞–≥—Ä–µ–≥–∏—Ä—É—é –∫—É—Ä—Å –æ–±–º–µ–Ω–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö –≤–∞–ª—é—Ç –≤ –£–∫—Ä–∞–∏–Ω–µ üá∫üá¶ –∏–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é ‚Äì –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –≤ –±–∞–Ω–∫–∞—Ö –∏ –ü–û–í –£–∫—Ä–∞–∏–Ω—ã.\n–Ø –∑–Ω–∞—é –∫—É—Ä—Å –≤–∞–ª—é—Ç –¥–ª—è:\n${allCurrenciesList}\n\n–°–µ–π—á–∞—Å –≤ —Ç–≤–æ–µ–º —Å–ø–∏—Å–∫–µ —Ç–∞–∫–∏–µ –≤–∞–ª—é—Ç—ã:\n*${userCurrenciesList}*`;

      const options: TelegramBot.SendMessageOptions = {
        parse_mode: 'Markdown',
      };

      this._bot.sendMessage(_id, msg, options);
    } catch (e) {
      console.error(e);
    }
  };

  private _callbackQuery = async (CallbackQuery: TelegramBot.CallbackQuery) => {
    try {
      const { data, message } = CallbackQuery;
      const { text, message_id: messageId } = message!;
      const { id: _id } = message!.chat;

      const editMessageOptions = {
        chat_id: _id,
        message_id: messageId,
        reply_markup: {
          parse_mode: 'Markdown',
          inline_keyboard: [],
        },
      };

      this._bot.editMessageText(text!, editMessageOptions);

      const { action, payload }: IAction = JSON.parse(data!);

      switch (action) {
        case Actions.ADD_CURRENCIES: {
          this.handleAddCurrencies(_id);
          break;
        }
        case Actions.REMOVE_CURRENCIES: {
          this.handleRemoveCurrencies(_id);
          break;
        }
        case Actions.ADD_CURRENCY: {
          this.handleAddCurrency(_id, payload);
          break;
        }
        case Actions.REMOVE_CURRENCY: {
          this.handleRemoveCurrency(_id, payload);
          break;
        }
        default: {
          const _: never = action;
          throw new Error(`Unknown action ${_}`);
        }
      }
    } catch (e) {
      console.error(e);
    }
  };

  private handleAddCurrencies = async (_id: number) => {
    try {
      const foundUser = await this._usersRepository.find(_id);

      if (!foundUser) {
        throw new Error("User wasn't found");
      }

      const { currencies } = foundUser;

      const globalCurrencies = Object.values(Currencies);

      const potentialCurrencies = difference(globalCurrencies, currencies);

      if (!potentialCurrencies.length) {
        this._bot.sendMessage(
          _id,
          '–£ —Ç–µ–±—è —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª—é—Ç üòâ',
        );
        return;
      }

      const options: TelegramBot.SendMessageOptions = {
        reply_markup: {
          inline_keyboard: potentialCurrencies.map((currency) => [
            {
              text: currency,
              callback_data: JSON.stringify({
                action: Actions.ADD_CURRENCY,
                payload: currency,
              }),
            },
          ]),
        },
      };

      this._bot.sendMessage(_id, '–ö–∞–∫—É—é –≤–∞–ª—é—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å?', options);
    } catch (e) {
      console.error(e);
    }
  };

  private handleAddCurrency = async (_id: number, currency: Currencies) => {
    try {
      await this._usersRepository.addCurrency(_id, currency);

      const options: TelegramBot.SendMessageOptions = {
        parse_mode: 'Markdown',
      };

      this._bot.sendMessage(
        _id,
        `–ì–æ—Ç–æ–≤–æ! –î–æ–±–∞–≤–∏–ª–∏: *${getCurrencyWithFlag(currency)}*`,
        options,
      );
    } catch (e) {
      console.error(e);
    }
  };

  private handleRemoveCurrencies = async (_id: number) => {
    try {
      const foundUser = await this._usersRepository.find(_id);

      if (!foundUser) {
        throw new Error("User wasn't found");
      }

      const { currencies } = foundUser;

      if (!currencies.length) {
        this._bot.sendMessage(_id, '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–ª—é—Ç ü§≠');
        return;
      }

      const options: TelegramBot.SendMessageOptions = {
        reply_markup: {
          inline_keyboard: currencies.map((currency) => [
            {
              text: currency,
              callback_data: JSON.stringify({
                action: Actions.REMOVE_CURRENCY,
                payload: currency,
              }),
            },
          ]),
        },
      };

      this._bot.sendMessage(_id, '–ö–∞–∫—É—é –≤–∞–ª—é—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–¥–∞–ª–∏—Ç—å?', options);
    } catch (e) {
      console.error(e);
    }
  };

  private handleRemoveCurrency = async (_id: number, currency: Currencies) => {
    try {
      await this._usersRepository.removeCurrency(_id, currency);

      const options: TelegramBot.SendMessageOptions = {
        parse_mode: 'Markdown',
      };

      this._bot.sendMessage(
        _id,
        `–ì–æ—Ç–æ–≤–æ! –£–¥–∞–ª–∏–ª–∏ *${getCurrencyWithFlag(currency)}*`,
        options,
      );
    } catch (e) {
      console.error(e);
    }
  };
}

export default Bot;
